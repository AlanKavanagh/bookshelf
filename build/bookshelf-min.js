!function(a){"object"==typeof exports?module.exports=a():"function"==typeof define&&define.amd?define(["bluebird","lodash","knex","backbone"],a):"undefined"!=typeof window?window.bookshelf=a():"undefined"!=typeof global?global.bookshelf=a():"undefined"!=typeof self&&(self.bookshelf=a())}(function(){var a;return function b(a,c,d){function e(g,h){if(!c[g]){if(!a[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};a[g][0].call(j.exports,function(b){var c=a[g][1][b];return e(c?c:b)},j,j.exports,b,a,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){var c=a("lodash"),d=a("knex"),e=a("./dialects/sql/model").Model,f=a("./dialects/sql/collection").Collection,g=a("./dialects/sql/relation").Relation,h=a("./dialects/base/events").Events,i=function(a){if(!(this instanceof i))return new i(a);a.client&&a.client instanceof d.ClientBase||(a=new d(a));var b=this.Model=e.extend({_builder:function(b){return a(b)},_relation:function(a,b,c){return new h(a,b,c)}}),c=this.Collection=f.extend({model:b,_builder:function(b){return a(b)}}),h=i.Relation=g.extend({Model:b,Collection:c});this.knex=a};c.extend(i.prototype,h,{VERSION:"0.6.2",transaction:function(){return this.knex.transaction.apply(this,arguments)},plugin:function(a){return a(this),this}}),i.initialize=function(a){return new this(a)},e.forge=f.forge=function(){var a=Object.create(this.prototype),b=this.apply(a,arguments);return Object(b)===b?b:a},b.exports=i},{"./dialects/base/events":4,"./dialects/sql/collection":8,"./dialects/sql/model":11,"./dialects/sql/relation":12,knex:!1,lodash:!1}],2:[function(a,b,c){var d=a("lodash"),e=a("backbone"),f=a("./events").Events,g=a("./promise").Promise,h=a("./model").ModelBase,i=[],j=i.push,k=i.splice,l=function(a,b){b&&d.extend(this,d.pick(b,m)),this._reset(),this.initialize.apply(this,arguments),a&&this.reset(a,d.extend({silent:!0},b))},m=["model","comparator"],n=["model","fetch","url","sync","create"],o={add:!0,remove:!0,merge:!0};d.extend(l.prototype,d.omit(e.Collection.prototype,n),f,{tableName:function(){return d.result(this.model.prototype,"tableName")},idAttribute:function(){return this.model.prototype.idAttribute},set:function(a,b){b=d.defaults({},b,o),b.parse&&(a=this.parse(a,b)),d.isArray(a)||(a=a?[a]:[]);var c,e,f,g,i,l,m=b.at,n=this.model,p=[],q=[],r={},s=b.add,t=b.merge,u=b.remove,v=s&&u?[]:!1;for(c=0,e=a.length;e>c;c++){if(i=a[c],f=i instanceof h?g=i:i[n.prototype.idAttribute],l=this.get(f)){if(u){r[l.cid]=!0;continue}t&&(i=i===g?g.attributes:i,b.parse&&(i=l.parse(i,b)),l.set(i,b))}else if(s){if(!(g=this._prepareModel(i,b)))continue;p.push(g),g.on("all",this._onModelEvent,this),this._byId[g.cid]=g,null!=g.id&&(this._byId[g.id]=g)}v&&v.push(l||g)}if(u){for(c=0,e=this.length;e>c;++c)r[(g=this.models[c]).cid]||q.push(g);q.length&&this.remove(q,b)}if((p.length||v&&v.length)&&(this.length+=p.length,null!=m?k.apply(this.models,[m,0].concat(p)):(v&&(this.models.length=0),j.apply(this.models,v||p))),b.silent)return this;for(c=0,e=p.length;e>c;c++)(g=p[c]).trigger("add",g,this,b);return this},_prepareModel:function(a,b){return a instanceof h?a:new this.model(a,b)},mapThen:function(a,b){return g.all(this.map(a,b))},invokeThen:function(){return g.all(this.invoke.apply(this,arguments))},fetch:function(){return g.rejected("The fetch method has not been implemented")}});l.extend=e.Collection.extend,l.include=function(){return d.extend.apply(d,[this.prototype].concat(d.toArray(arguments))),this},c.CollectionBase=l},{"./events":4,"./model":5,"./promise":6,backbone:!1,lodash:!1}],3:[function(a,b,c){var d=a("lodash"),e=a("backbone"),f=a("./promise").Promise,g=function(a,b,c){this.parent=a,this.parentResponse=b,this.target=c};g.prototype={fetch:f.method(function(a){var b,c,e,g=this.target,i=this.handled={},j=this.prepWithRelated(a.withRelated),k={};g._isEager=!0;for(var l in j){if(c=l.split("."),b=c[0],c.length>1){var m={};k[b]||(k[b]=[]),m[c.slice(1).join(".")]=j[l],k[b].push(m)}if(!i[b]){if(e=g[b](),!e)throw new Error(b+" is not defined on the model.");i[b]=e}}delete g._isEager;var n=[];for(b in i)n.push(this.eagerFetch(b,i[b],d.extend({},a,{isEager:!0,withRelated:k[b],beforeFn:j[b]||h})));return f.all(n).yield(this.parentResponse)}),prepWithRelated:function(a){d.isArray(a)||(a=[a]);for(var b={},c=0,e=a.length;e>c;c++){var f=a[c];d.isString(f)?b[f]=h:d.extend(b,f)}return b},pushModels:function(a,b,c){for(var d=this.parent,e=b.relatedData,f=[],g=0,h=c.length;h>g;g++)f.push(e.createModel(c[g]));return e.eagerPair(a,f,d)}};var h=function(){};g.extend=e.Model.extend,c.EagerBase=g},{"./promise":6,backbone:!1,lodash:!1}],4:[function(a,b,c){var d=a("./promise").Promise,e=a("backbone"),f=a("trigger-then");f(e,d),c.Events=e.Events},{"./promise":6,backbone:!1,"trigger-then":15}],5:[function(a,b,c){var d=a("lodash"),e=a("backbone"),f=a("./events").Events,g=a("./promise").Promise,h=function(a,b){var c=a||{};b||(b={}),this.attributes=Object.create(null),this._reset(),this.relations={},this.cid=d.uniqueId("c"),b&&(d.extend(this,d.pick(b,i)),b.parse&&(c=this.parse(c,b)||{})),this.set(c,b),this.initialize.apply(this,arguments)};d.extend(h.prototype,d.omit(e.Model.prototype),f,{set:function(a,b,c){if(null==a)return this;var e;"object"==typeof a?(e=a,c=b):(e={})[a]=b,c||(c={});var f=!1,g=c.unset,h=this.attributes,i=this._previousAttributes;this.idAttribute in e&&(this.id=e[this.idAttribute]);for(var j in e)b=e[j],d.isEqual(i[j],b)?delete this.changed[j]:(this.changed[j]=b,d.isEqual(h[j],b)||(f=!0)),g?delete h[j]:h[j]=b;return f&&!c.silent&&this.trigger("change",this,c),this},toJSON:function(a){var b=d.extend({},this.attributes);if(a&&a.shallow)return b;var c=this.relations;for(var e in c){var f=c[e];b[e]=f.toJSON?f.toJSON():f}if(this.pivot){var g=this.pivot.attributes;for(e in g)b["_pivot_"+e]=g[e]}return b},parse:function(a){return a},format:function(a){return a},related:function(a){return this.relations[a]||(this[a]?this.relations[a]=this[a]():void 0)},clone:function(){var a=new this.constructor(this.attributes),b=this.relations;for(var c in b)a.relations[c]=b[c].clone();return a._previousAttributes=d.clone(this._previousAttributes),a.changed=d.clone(this.changed),a},timestamp:function(a){var b=new Date,c=d.isArray(this.hasTimestamps)?this.hasTimestamps:["created_at","updated_at"],e={};return e[c[1]]=b,!this.isNew(a)||a&&"update"===a.method||(e[c[0]]=b),e},_reset:function(){return this._previousAttributes=d.extend(Object.create(null),this.attributes),this.changed=Object.create(null),this},fetch:function(){},save:function(){},destroy:g.method(function(a){return a=a?d.clone(a):{},g.bind(this).then(function(){return this.triggerThen("destroying",this,a)}).then(function(){return this.sync(a).del()}).then(function(b){return this.clear(),this.triggerThen("destroyed",this,b,a)}).then(this._reset)})});var i=["tableName","hasTimestamps"];h.extend=e.Model.extend,h.include=function(){return d.extend.apply(d,[this.prototype].concat(d.toArray(arguments))),this},c.ModelBase=h},{"./events":4,"./promise":6,backbone:!1,lodash:!1}],6:[function(a,b,c){var d=a("bluebird");d.prototype.yield=function(a){return this.then(function(){return a})},d.prototype.tap=function(a){return this.then(a).yield(this)},d.prototype.ensure=d.prototype.lastly,d.prototype.otherwise=d.prototype.caught,d.prototype.exec=d.prototype.nodeify,d.resolve=d.fulfilled,d.reject=d.rejected,c.Promise=d},{bluebird:!1}],7:[function(a,b,c){var d=a("lodash"),e=a("backbone"),f=a("./collection").CollectionBase,g=function(a,b,c){this.type=a,(this.target=b)&&(this.targetTableName=d.result(b.prototype,"tableName"),this.targetIdAttribute=d.result(b.prototype,"idAttribute")),d.extend(this,c)};g.prototype={instance:function(a,b,c){return new this.constructor(a,b,c)},createModel:function(a){return this.target.prototype instanceof f?new this.target.prototype.model(a)._reset():new this.target(a)._reset()},eagerPair:function(){}},g.extend=e.Model.extend,c.RelationBase=g},{"./collection":2,backbone:!1,lodash:!1}],8:[function(a,b,c){function d(a){var b=this.relatedData;this.set(a,{silent:!0,parse:!0}).invoke("_reset"),b&&b.isJoined()&&b.parsePivot(this.models)}function e(a){return function(b){return new i(this.models,b,new this.model).fetch(a)}}var f=a("lodash"),g=a("./sync").Sync,h=a("./helpers").Helpers,i=a("./eager").EagerRelation,j=a("../base/collection").CollectionBase,k=a("../base/promise").Promise;c.Collection=j.extend({through:function(a,b,c){return this.relatedData.through(this,a,{throughForeignKey:b,otherKey:c})},fetch:k.method(function(a){a=a?f.clone(a):{};var b=this.sync(a).select().bind(this).tap(function(b){if(!b||0===b.length){if(a.require)throw new Error("EmptyResponse");return k.reject(null)}}).tap(d);return a.withRelated&&(b=b.tap(e(f.omit(a,"columns")))),b.tap(function(b){return this.triggerThen("fetched",this,b,a)}).caught(function(a){if(null!==a)throw a;this.reset([],{silent:!0})}).yield(this)}),fetchOne:k.method(function(a){var b=new this.model;return b._knex=this.query().clone(),this.relatedData&&(b.relatedData=this.relatedData),b.fetch(a)}),load:k.method(function(a,b){return f.isArray(a)||(a=[a]),b=f.extend({},b,{shallow:!0,withRelated:a}),new i(this.models,this.toJSON(b),new this.model).fetch(b).yield(this)}),create:k.method(function(a,b){b=b?f.clone(b):{};var c=this.relatedData;return a=this._prepareModel(a,b),this._knex&&(a._knex=this._knex,this.resetQuery()),h.saveConstraints(a,c).save(null,b).bind(this).then(function(){return c&&("belongsToMany"===c.type||c.isThrough())?this.attach(a,b):void 0}).then(function(){return this.add(a,b),a})}),resetQuery:function(){return this._knex=null,this},query:function(){return h.query(this,f.toArray(arguments))},sync:function(a){return new g(this,a)}})},{"../base/collection":2,"../base/promise":6,"./eager":9,"./helpers":10,"./sync":13,lodash:!1}],9:[function(a,b,c){function d(a,b,c,d){return function(g){var h=a.pushModels(b,c,g),i=c.relatedData;if(g.length>0&&d.withRelated){var k=i.createModel();if("morphTo"===i.type){var l=e(k,d);if(0===l.length)return;d=f.extend({},d,{withRelated:l})}return new j(h,g,k).fetch(d).yield(g)}}}function e(a,b){return f.reduce(b.withRelated,function(b,c){for(var d in c){var e=d.split(".")[0];f.isFunction(a[e])&&b.push(c)}return b},[])}var f=a("lodash"),g=a("./helpers").Helpers,h=a("../base/eager").EagerBase,i=a("../base/promise").Promise,j=c.EagerRelation=h.extend({eagerFetch:i.method(function(a,b,c){var e=b.relatedData;return"morphTo"===e.type?this.morphToFetch(a,e,c):(c.beforeFn.call(b,b.query()),b.sync(f.extend({},c,{parentResponse:this.parentResponse})).select().tap(d(this,a,b,c)))}),morphToFetch:i.method(function(a,b,c){var e=[],h=f.groupBy(this.parent,function(a){return a.get(b.morphName+"_type")});for(var j in h){var k=g.morphCandidate(b.candidates,j),l=new k;e.push(l.query("whereIn",f.result(l,"idAttribute"),f.uniq(f.invoke(h[j],"get",b.morphName+"_id"))).sync(c).select().tap(d(this,a,{relatedData:b.instance("morphTo",k,{morphName:b.morphName})},c)))}return i.all(e).then(function(a){return f.flatten(a)})})})},{"../base/eager":3,"../base/promise":6,"./helpers":10,lodash:!1}],10:[function(a,b,c){var d=a("lodash");c.Helpers={saveConstraints:function(a,b){var c={};return b&&b.type&&"belongsToMany"!==b.type&&(c[b.key("foreignKey")]=b.parentFk,b.isMorph()&&(c[b.key("morphKey")]=b.key("morphValue"))),a.set(c)},morphCandidate:function(a,b){var c=d.find(a,function(a){return d.result(a.prototype,"tableName")===b});if(!c)throw new Error("The target polymorphic model was not found");return c},query:function(a,b){if(a._knex=a._knex||a._builder(d.result(a,"tableName")),0===b.length)return a._knex;var c=b[0];if(d.isFunction(c))c.call(a._knex,a._knex);else if(d.isObject(c))for(var e in c){var f=d.isArray(c[e])?c[e]:[c[e]];a._knex[e].apply(a._knex,f)}else a._knex[c].apply(a._knex,b.slice(1));return a}}},{lodash:!1}],11:[function(a,b,c){function d(a){var b=this.relatedData;this.set(this.parse(a[0]),{silent:!0})._reset(),b&&b.isJoined()&&b.parsePivot([this])}function e(a){return function(b){return new i([this],b,this).fetch(a)}}var f=a("lodash"),g=a("./sync").Sync,h=a("./helpers").Helpers,i=a("./eager").EagerRelation,j=a("../base/model").ModelBase,k=a("../base/promise").Promise;c.Model=j.extend({hasOne:function(a,b){return this._relation("hasOne",a,{foreignKey:b}).init(this)},hasMany:function(a,b){return this._relation("hasMany",a,{foreignKey:b}).init(this)},belongsTo:function(a,b){return this._relation("belongsTo",a,{foreignKey:b}).init(this)},belongsToMany:function(a,b,c,d){return this._relation("belongsToMany",a,{joinTableName:b,foreignKey:c,otherKey:d}).init(this)},morphOne:function(a,b,c){return this._morphOneOrMany(a,b,c,"morphOne")},morphMany:function(a,b,c){return this._morphOneOrMany(a,b,c,"morphMany")},morphTo:function(a){if(!f.isString(a))throw new Error("The `morphTo` name must be specified.");return this._relation("morphTo",null,{morphName:a,candidates:f.rest(arguments)}).init(this)},through:function(a,b,c){return this.relatedData.through(this,a,{throughForeignKey:b,otherKey:c})},fetch:k.method(function(a){a=a?f.clone(a):{};var b=this.sync(a).first().bind(this).tap(function(b){if(!b||0===b.length){if(a.require)throw new Error("EmptyResponse");return k.reject(null)}}).tap(d);return a.withRelated&&(b=b.tap(e(f.omit(a,"columns")))),b.tap(function(b){return this.triggerThen("fetched",this,b,a)}).yield(this).caught(function(a){if(null===a)return a;throw a})}),load:k.method(function(a,b){return k.bind(this).then(function(){return[this.toJSON({shallow:!0})]}).then(e(f.extend({},b,{shallow:!0,withRelated:f.isArray(a)?a:[a]}))).yield(this)}),save:k.method(function(a,b,c){var d;return null==a||"object"==typeof a?(d=a||{},c=b||{}):((d={})[a]=b,c=c?f.clone(c):{}),k.bind(this).then(function(){return this.isNew(c)}).then(function(a){this.hasTimestamps&&f.extend(d,this.timestamp(c)),c.method=(c.method||(a?"insert":"update")).toLowerCase();var b=c.method,e=d;if("insert"===b||c.defaults){var g=f.result(this,"defaults");g&&(e=f.extend({},g,this.attributes,e))}this.set(e,{silent:!0}),this.relatedData&&"morphTo"!==this.relatedData.type&&h.saveConstraints(this,this.relatedData);var i=this.sync(c);return c.query=i.query,k.all([this.triggerThen("insert"===b?"creating":"updating",this,d,c),this.triggerThen("saving",this,d,c)]).bind(this).then(function(){return i[c.method]("update"===b&&c.patch?d:this.attributes)}).then(function(a){if("insert"===b&&null==this.id)this.attributes[this.idAttribute]=this.id=a[0];else if("update"===b&&0===a)throw new Error("No rows were affected in the update, did you mean to pass the {insert: true} option?");return c.previousAttributes=this._previousAttributes,this._reset(),k.all([this.triggerThen("insert"===b?"created":"updated",this,a,c),this.triggerThen("saved",this,a,c)])})}).yield(this)}),resetQuery:function(){return this._knex=null,this},query:function(){return h.query(this,f.toArray(arguments))},sync:function(a){return new g(this,a)},_morphOneOrMany:function(a,b,c,d){if(!b||!a)throw new Error("The polymorphic `name` and `Target` are required.");return this._relation(d,a,{morphName:b,morphValue:c}).init(this)}})},{"../base/model":5,"../base/promise":6,"./eager":9,"./helpers":10,"./sync":13,lodash:!1}],12:[function(a,b,c){var d=a("lodash"),e=a("inflection"),f=a("./helpers").Helpers,g=a("../base/model").ModelBase,h=a("../base/relation").RelationBase,i=a("../base/promise").Promise,j=[].push;c.Relation=h.extend({init:function(a){this.parentId=a.id,this.parentTableName=d.result(a,"tableName"),this.parentIdAttribute=d.result(a,"idAttribute"),this.isInverse()?("morphTo"!==this.type||a._isEager||(this.target=f.morphCandidate(this.candidates,a.get(this.key("morphKey"))),this.targetTableName=d.result(this.target.prototype,"tableName"),this.targetIdAttribute=d.result(this.target.prototype,"idAttribute")),this.parentFk=a.get(this.key("foreignKey"))):this.parentFk=a.id;var b=this.target?this.relatedInstance():{};return b.relatedData=this,"belongsToMany"===this.type&&d.extend(b,l),b},through:function(a,b,c){var e=this.type;if("hasOne"!==e&&"hasMany"!==e&&"belongsToMany"!==e&&"belongsTo"!==e)throw new Error("`through` is only chainable from `hasOne`, `belongsTo`, `hasMany`, or `belongsToMany`");return this.throughTarget=b,this.throughTableName=d.result(b.prototype,"tableName"),this.throughIdAttribute=d.result(b.prototype,"idAttribute"),"belongsTo"===this.type&&(this.parentFk=this.parentId),d.extend(this,c),d.extend(a,l),"belongsToMany"===this.type&&(this.foreignKey=this.throughForeignKey),a},key:function(a){return this[a]?this[a]:"otherKey"===a?this[a]=k(this.targetTableName)+"_"+this.targetIdAttribute:"throughForeignKey"===a?this[a]=k(this.joinTable())+"_"+this.throughIdAttribute:"foreignKey"===a?this[a]="morphTo"===this.type?this.morphName+"_id":"belongsTo"===this.type?k(this.targetTableName)+"_"+this.targetIdAttribute:this.isMorph()?this.morphName+"_id":k(this.parentTableName)+"_"+this.parentIdAttribute:"morphKey"===a?this[a]=this.morphName+"_type":"morphValue"===a?this[a]=this.parentTableName||this.targetTableName:void 0},selectConstraints:function(a,b){var c=b.parentResponse;0!==a.columns.length||b.columns&&0!==b.columns.length?d.isArray(b.columns)&&b.columns.length>0&&j.apply(a.columns,b.columns):a.columns.push(this.targetTableName+".*"),this.isJoined()&&(this.joinClauses(a),this.joinColumns(a)),this.isSingle()&&!c&&a.limit(1),this.whereClauses(a,c)},joinColumns:function(a){var b=[],c=this.joinTable();this.isThrough()&&b.push(this.throughIdAttribute),b.push(this.key("foreignKey")),"belongsToMany"===this.type&&b.push(this.key("otherKey")),j.apply(b,this.pivotColumns),j.apply(a.columns,d.map(b,function(a){return c+"."+a+" as _pivot_"+a}))},joinClauses:function(a){var b=this.joinTable();if("belongsTo"===this.type||"belongsToMany"===this.type){var c="belongsTo"===this.type?this.key("foreignKey"):this.key("otherKey");a.join(b,b+"."+c,"=",this.targetTableName+"."+this.targetIdAttribute),"belongsTo"===this.type&&a.join(this.parentTableName,b+"."+this.throughIdAttribute,"=",this.parentTableName+"."+this.key("throughForeignKey"))}else a.join(b,b+"."+this.throughIdAttribute,"=",this.targetTableName+"."+this.key("throughForeignKey"))},whereClauses:function(a,b){var c;if(this.isJoined()){var d="belongsTo"===this.type?this.parentTableName:this.joinTable();c=d+"."+("belongsTo"===this.type?this.parentIdAttribute:this.key("foreignKey"))}else c=this.targetTableName+"."+(this.isInverse()?this.targetIdAttribute:this.key("foreignKey"));a[b?"whereIn":"where"](c,b?this.eagerKeys(b):this.parentFk),this.isMorph()&&a.where(this.targetTableName+"."+this.key("morphKey"),this.key("morphValue"))},eagerKeys:function(a){return d.uniq(d.pluck(a,this.isInverse()?this.key("foreignKey"):this.parentIdAttribute))},joinTable:function(){return this.isThrough()?this.throughTableName:this.joinTableName||[this.parentTableName,this.targetTableName].sort().join("_")},relatedInstance:function(a){a||(a=[]);var b=this.target;if(this.isSingle()){if(!(b.prototype instanceof g))throw new Error("The `"+this.type+"` related object must be a Bookshelf.Model");return a[0]||new b}return b.prototype instanceof g&&(b=this.Collection.extend({model:b,_builder:b.prototype._builder})),new b(a,{parse:!0})},eagerPair:function(a,b,c){var e;"morphTo"===this.type&&(c=d.filter(c,function(a){return a.get(this.key("morphKey"))===this.key("morphValue")},this)),this.isJoined()&&(b=this.parsePivot(b));for(var f=d.groupBy(b,function(a){return a.pivot?a.pivot.get(this.key("foreignKey")):this.isInverse()?a.id:a.get(this.key("foreignKey"))},this),g=0,h=c.length;h>g;g++){e=c[g];var i=this.isInverse()?e.get(this.key("foreignKey")):e.id,j=e.relations[a]=this.relatedInstance(f[i]);j.relatedData=this,this.isJoined()&&d.extend(j,l)}for(g=0,h=b.length;h>g;g++)e=b[g],e.attributes=e.parse(e.attributes);return b},parsePivot:function(a){var b=this.throughTarget;return d.map(a,function(a){var c,e={},f={},g=a.attributes;b&&(c=new b);for(var h in g)0===h.indexOf("_pivot_")?e[h.slice(7)]=g[h]:f[h]=g[h];return a.attributes=f,d.isEmpty(e)||(a.pivot=c?c.set(e,{silent:!0}):new this.Model(e,{tableName:this.joinTable()})),a},this)},isThrough:function(){return null!=this.throughTarget},isJoined:function(){return"belongsToMany"===this.type||this.isThrough()},isMorph:function(){return"morphOne"===this.type||"morphMany"===this.type},isSingle:function(){var a=this.type;return"hasOne"===a||"belongsTo"===a||"morphOne"===a||"morphTo"===a},isInverse:function(){return"belongsTo"===this.type||"morphTo"===this.type},withPivot:function(a){d.isArray(a)||(a=[a]),this.pivotColumns||(this.pivotColumns=[]),j.apply(this.pivotColumns,a)}});var k=function(){var a=Object.create(null);return function(b){return b in a?a[b]:a[b]=e.singularize(b)}}(),l={attach:function(a,b){return this._handler("insert",a,b)},detach:function(a,b){return this._handler("delete",a,b)},withPivot:function(a){return this.relatedData.withPivot(a),this},_handler:i.method(function(a,b,c){var e=[];if(void 0==b){if("insert"===a)return i.resolve(this);"delete"===a&&e.push(this._processPivot(a,null,c))}d.isArray(b)||(b=b?[b]:[]);for(var f=0,g=b.length;g>f;f++)e.push(this._processPivot(a,b[f],c));return i.all(e).yield(this)}),_processPivot:i.method(function(a,b,c){var e={},f=this.relatedData;e[f.key("foreignKey")]=f.parentFk,d.isObject(b)?b instanceof g?e[f.key("otherKey")]=b.id:d.extend(e,b):b&&(e[f.key("otherKey")]=b);var h=this._builder(f.joinTable());c&&(c.transacting&&h.transacting(c.transacting),c.debug&&h.debug());var i=this;return"delete"===a?h.where(e).del().then(function(){var a;return b?((a=i.get(e[f.key("otherKey")]))&&i.remove(a),void 0):i.reset()}):h.insert(e).then(function(){i.add(b)})})}},{"../base/model":5,"../base/promise":6,"../base/relation":7,"./helpers":10,inflection:14,lodash:!1}],13:[function(a,b,c){var d=a("lodash"),e=a("../base/promise").Promise,f=function(a,b){b||(b={}),this.query=a.query(),this.syncing=a.resetQuery(),this.options=b,b.debug&&this.query.debug(),b.transacting&&this.query.transacting(b.transacting)};d.extend(f.prototype,{first:e.method(function(){return this.query.where(this.syncing.format(d.extend(Object.create(null),this.syncing.attributes))).limit(1),this.select()}),select:e.method(function(){var a,b=this.options,c=this.syncing.relatedData;return c?c.selectConstraints(this.query,b):(a=b.columns,d.isArray(a)||(a=a?[a]:[d.result(this.syncing,"tableName")+".*"])),b.query=this.query,e.bind(this).then(function(){return this.syncing.triggerThen("fetching",this.syncing,a,b)}).then(function(){return this.query.select(a)})}),insert:e.method(function(){var a=this.syncing;return this.query.insert(a.format(d.extend(Object.create(null),a.attributes)),a.idAttribute)}),update:e.method(function(a){var b=this.syncing,c=this.query;if(null!=b.id&&c.where(b.idAttribute,b.id),0===c.wheres.length)throw new Error('A model cannot be updated without a "where" clause or an idAttribute.');return c.update(b.format(d.extend(Object.create(null),a)))}),del:e.method(function(){var a=this.query,b=this.syncing;if(null!=b.id&&a.where(b.idAttribute,b.id),0===a.wheres.length)throw new Error('A model cannot be destroyed without a "where" clause or an idAttribute.');return this.query.del()})}),c.Sync=f},{"../base/promise":6,lodash:!1}],14:[function(a,b,c){!function(a){var d=["equipment","information","rice","money","species","series","fish","sheep","moose","deer","news"],e=[[new RegExp("(m)en$","gi")],[new RegExp("(pe)ople$","gi")],[new RegExp("(child)ren$","gi")],[new RegExp("([ti])a$","gi")],[new RegExp("((a)naly|(b)a|(d)iagno|(p)arenthe|(p)rogno|(s)ynop|(t)he)ses$","gi")],[new RegExp("(hive)s$","gi")],[new RegExp("(tive)s$","gi")],[new RegExp("(curve)s$","gi")],[new RegExp("([lr])ves$","gi")],[new RegExp("([^fo])ves$","gi")],[new RegExp("([^aeiouy]|qu)ies$","gi")],[new RegExp("(s)eries$","gi")],[new RegExp("(m)ovies$","gi")],[new RegExp("(x|ch|ss|sh)es$","gi")],[new RegExp("([m|l])ice$","gi")],[new RegExp("(bus)es$","gi")],[new RegExp("(o)es$","gi")],[new RegExp("(shoe)s$","gi")],[new RegExp("(cris|ax|test)es$","gi")],[new RegExp("(octop|vir)i$","gi")],[new RegExp("(alias|status)es$","gi")],[new RegExp("^(ox)en","gi")],[new RegExp("(vert|ind)ices$","gi")],[new RegExp("(matr)ices$","gi")],[new RegExp("(quiz)zes$","gi")],[new RegExp("(m)an$","gi"),"$1en"],[new RegExp("(pe)rson$","gi"),"$1ople"],[new RegExp("(child)$","gi"),"$1ren"],[new RegExp("^(ox)$","gi"),"$1en"],[new RegExp("(ax|test)is$","gi"),"$1es"],[new RegExp("(octop|vir)us$","gi"),"$1i"],[new RegExp("(alias|status)$","gi"),"$1es"],[new RegExp("(bu)s$","gi"),"$1ses"],[new RegExp("(buffal|tomat|potat)o$","gi"),"$1oes"],[new RegExp("([ti])um$","gi"),"$1a"],[new RegExp("sis$","gi"),"ses"],[new RegExp("(?:([^f])fe|([lr])f)$","gi"),"$1$2ves"],[new RegExp("(hive)$","gi"),"$1s"],[new RegExp("([^aeiouy]|qu)y$","gi"),"$1ies"],[new RegExp("(x|ch|ss|sh)$","gi"),"$1es"],[new RegExp("(matr|vert|ind)ix|ex$","gi"),"$1ices"],[new RegExp("([m|l])ouse$","gi"),"$1ice"],[new RegExp("(quiz)$","gi"),"$1zes"],[new RegExp("s$","gi"),"s"],[new RegExp("$","gi"),"s"]],f=[[new RegExp("(m)an$","gi")],[new RegExp("(pe)rson$","gi")],[new RegExp("(child)$","gi")],[new RegExp("^(ox)$","gi")],[new RegExp("(ax|test)is$","gi")],[new RegExp("(octop|vir)us$","gi")],[new RegExp("(alias|status)$","gi")],[new RegExp("(bu)s$","gi")],[new RegExp("(buffal|tomat|potat)o$","gi")],[new RegExp("([ti])um$","gi")],[new RegExp("sis$","gi")],[new RegExp("(?:([^f])fe|([lr])f)$","gi")],[new RegExp("(hive)$","gi")],[new RegExp("([^aeiouy]|qu)y$","gi")],[new RegExp("(x|ch|ss|sh)$","gi")],[new RegExp("(matr|vert|ind)ix|ex$","gi")],[new RegExp("([m|l])ouse$","gi")],[new RegExp("(quiz)$","gi")],[new RegExp("(m)en$","gi"),"$1an"],[new RegExp("(pe)ople$","gi"),"$1rson"],[new RegExp("(child)ren$","gi"),"$1"],[new RegExp("([ti])a$","gi"),"$1um"],[new RegExp("((a)naly|(b)a|(d)iagno|(p)arenthe|(p)rogno|(s)ynop|(t)he)ses$","gi"),"$1$2sis"],[new RegExp("(hive)s$","gi"),"$1"],[new RegExp("(tive)s$","gi"),"$1"],[new RegExp("(curve)s$","gi"),"$1"],[new RegExp("([lr])ves$","gi"),"$1f"],[new RegExp("([^fo])ves$","gi"),"$1fe"],[new RegExp("([^aeiouy]|qu)ies$","gi"),"$1y"],[new RegExp("(s)eries$","gi"),"$1eries"],[new RegExp("(m)ovies$","gi"),"$1ovie"],[new RegExp("(x|ch|ss|sh)es$","gi"),"$1"],[new RegExp("([m|l])ice$","gi"),"$1ouse"],[new RegExp("(bus)es$","gi"),"$1"],[new RegExp("(o)es$","gi"),"$1"],[new RegExp("(shoe)s$","gi"),"$1"],[new RegExp("(cris|ax|test)es$","gi"),"$1is"],[new RegExp("(octop|vir)i$","gi"),"$1us"],[new RegExp("(alias|status)es$","gi"),"$1"],[new RegExp("^(ox)en","gi"),"$1"],[new RegExp("(vert|ind)ices$","gi"),"$1ex"],[new RegExp("(matr)ices$","gi"),"$1ix"],[new RegExp("(quiz)zes$","gi"),"$1"],[new RegExp("ss$","gi"),"ss"],[new RegExp("s$","gi"),""]],g=["and","or","nor","a","an","the","so","but","to","of","at","by","from","into","on","onto","off","out","in","over","with","for"],h=new RegExp("(_ids|_id)$","g"),i=new RegExp("_","g"),j=new RegExp("[ _]","g"),k=new RegExp("([A-Z])","g"),l=new RegExp("^_"),m={_apply_rules:function(a,b,c,d){if(d)a=d;else{var e=m.indexOf(c,a.toLowerCase())>-1;if(!e)for(var f=0,g=b.length;g>f;f++)if(a.match(b[f][0])){void 0!==b[f][1]&&(a=a.replace(b[f][0],b[f][1]));break}}return a},indexOf:function(a,b,c,d){c||(c=-1);for(var e=-1,f=c,g=a.length;g>f;f++)if(a[f]===b||d&&d(a[f],b)){e=f;break}return e},pluralize:function(a,b){return m._apply_rules(a,e,d,b)},singularize:function(a,b){return m._apply_rules(a,f,d,b)},camelize:function(a,b){for(var c=a.toLowerCase().split("/"),d=0,e=c.length;e>d;d++){for(var f=c[d].split("_"),g=b&&d+1===e?1:0,h=g,i=f.length;i>h;h++)f[h]=f[h].charAt(0).toUpperCase()+f[h].substring(1);c[d]=f.join("")}return c.join("::")},underscore:function(a,b){if(b&&a===a.toUpperCase())return a;for(var c=a.split("::"),d=0,e=c.length;e>d;d++)c[d]=c[d].replace(k,"_$1"),c[d]=c[d].replace(l,"");return c.join("/").toLowerCase()},humanize:function(a,b){return a=a.toLowerCase(),a=a.replace(h,""),a=a.replace(i," "),b||(a=m.capitalize(a)),a},capitalize:function(a){return a=a.toLowerCase(),a.substring(0,1).toUpperCase()+a.substring(1)},dasherize:function(a){return a.replace(j,"-")},titleize:function(a){a=a.toLowerCase().replace(i," ");for(var b=a.split(" "),c=0,d=b.length;d>c;c++){for(var e=b[c].split("-"),f=0,h=e.length;h>f;f++)m.indexOf(g,e[f].toLowerCase())<0&&(e[f]=m.capitalize(e[f]));b[c]=e.join("-")}return a=b.join(" "),a=a.substring(0,1).toUpperCase()+a.substring(1)},demodulize:function(a){var b=a.split("::");return b[b.length-1]},tableize:function(a){return a=m.underscore(a),a=m.pluralize(a)},classify:function(a){return a=m.camelize(a),a=m.singularize(a)},foreign_key:function(a,b){return a=m.demodulize(a),a=m.underscore(a)+(b?"":"_")+"id"},ordinalize:function(a){for(var b=a.split(" "),c=0,d=b.length;d>c;c++){var e=parseInt(b[c],10);if(!isNaN(e)){var f=b[c].substring(b[c].length-2),g=b[c].substring(b[c].length-1),h="th";"11"!=f&&"12"!=f&&"13"!=f&&("1"===g?h="st":"2"===g?h="nd":"3"===g&&(h="rd")),b[c]+=h}}return b.join(" ")}};return"undefined"==typeof c?a.inflection=m:(m.version="1.2.5",b.exports=m,void 0)}(this)},{}],15:[function(b,c,d){(function(b){"object"==typeof d?c.exports=b:"function"==typeof a&&a.amd?a("trigger-then",[],function(){return b}):this.triggerThen=b}).call(this,function(a,b){var c=a.Events,d=Array.prototype.push,e=Array.prototype.slice,f=/\s+/,g=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2],i=[];switch(b.length){case 0:for(;++d<e;)i.push((c=a[d]).callback.call(c.ctx));return i;case 1:for(;++d<e;)i.push((c=a[d]).callback.call(c.ctx,f));return i;case 2:for(;++d<e;)i.push((c=a[d]).callback.call(c.ctx,f,g));return i;case 3:for(;++d<e;)i.push((c=a[d]).callback.call(c.ctx,f,g,h));return i;default:for(;++d<e;)i.push((c=a[d]).callback.apply(c.ctx,b));return i}},h=c.triggerThen=function(a){if(!this._events)return b.all([]);var c=[a],h=e.call(arguments,1),i=[],j=[];f.test(c[0])&&(c=c[0].split(f));for(var k=0,l=c.length;l>k;k++)d.apply(j,this._events[c[k]]);var m=this._events.all;try{j&&d.apply(i,g(j,h)),m&&d.apply(i,g(m,arguments))}catch(n){return b.reject(n)}return b.all(i)};a.triggerThen=h;for(var i=["Model","Collection","Router","View","History"],j=0,k=i.length;k>j;j++)a[i[j]].prototype.triggerThen=h})},{}]},{},[1])(1)});